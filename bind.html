<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html;charset=utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge">
	<title>System Monitor</title>
	<link rel="stylesheet" href="resource/bootstrap/css/bootstrap.min.css">
	<script src="resource/js/jquery-2.1.1.min.js"></script>
	<script src="resource/bootstrap/js/bootstrap.js"></script>
</head>
<body>
<div class="panel panel-primary">
  <div class="panel-heading">绑定设备</div>
  <div class="panel-body">
    <form role="form">
	  <div class="form-group">
		<label for="product_sn">Product SN</label>
		<input type="text" class="form-control" id="product_sn" placeholder="SN">
	  </div>
	  <div class="form-group">
		<label for="product_key">Product Key</label>
		<input type="text" class="form-control" id="product_key" placeholder="Key">
	  </div>
	  
	  <div class="form-group">
		<label for="product_key">User Login</label>
		<input type="text" class="form-control" id="user_login" placeholder="User Login">
	  </div>
	  <div class="form-group">
		<button id="btn_bind" type="button" class="btn btn-primary">确定</button> 
		<a href="index.html" class="btn btn-info btn-sm">返回</a>
	  </div>
	</form>
	<div class="alert alert-success" style="display:none"></div>
  </div>
</div>

<script>
var fs = require("fs");
var Yeelink = require('./yeelink');

fs.readFile("config.txt", function(err, data){
	if(err) throw err;
	var data = JSON.parse(data);
	
	$("#product_sn").val(data.sn);
	$("#product_key").val(data.key);
	$("#user_login").val(data.user);
});


$("#btn_bind").click(function(){
	var sn = $("#product_sn").val();
	var key = $("#product_key").val();
	var user = $("#user_login").val();
	var obj = {
		sn: sn,
		key: key,
		user: user
	};
	
	var yee = new Yeelink(key, Yeelink.P_KEY);
	$('.alert').attr('class', 'alert alert-info').html('开始绑定产品').show();
	yee.bindProduct(sn, user, function(statusCode, body){
		if(statusCode != 200){
			$('.alert').attr('class', 'alert alert-danger').html(body).show();
			return;
		}
		$('.alert').attr('class', 'alert alert-info').html('开始获取产品信息').show();
		
		yee.productDeviceInfo(sn, function(statusCode, body){
			if(statusCode != 200){
				$('.alert').attr('class', 'alert alert-danger').html(body).show();
				return;
			}
			
			
			var deviceId = JSON.parse(body).id;
			obj.device_id = deviceId;
			$('.alert').attr('class', 'alert alert-info').html('开始获取传感器信息').show();
			yee.sensorList(deviceId, function(status, body){
				if(status != 200){
					$('.alert').attr('class', 'alert alert-danger').html(body).show();
					return;
				}
				
				var sensors = JSON.parse(body);
				var sensorIds = [];
				for(var i = 0, len = sensors.length; i < len; i++){
					sensorIds.push(sensors[i].id);
				}
				obj.sensorIds = sensorIds;
				fs.writeFile('config.txt', JSON.stringify(obj), function (err) {
					if (err) throw err;
					$('.alert').attr('class', 'alert alert-success').html('绑定成功').show();
				});
			});
			
			
		});
		//$('.alert').attr('class', 'alert alert-danger').html(body).show();
	});
});
</script>
</body>
</html>